#!/usr/bin/env bash
set -euo pipefail

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Dante SOCKS5 Proxy Installer with Username/Password (PAM) Auth
# Supported on Debian/Ubuntu
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# 1) –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root
if [[ $EUID -ne 0 ]]; then
  echo "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç root." >&2
  exit 1
fi

# 2) –°–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–∫—Å–∏-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–æ–∫—Å–∏-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " PROXY_USER
read -s -p "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è $PROXY_USER: " PROXY_PASS
echo

# 3) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dante-server
echo "üõ† –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç dante-server..."
apt update
apt install -y dante-server

# 4) –°–æ–∑–¥–∞—ë–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ shell‚Äô–∞ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
if ! id "$PROXY_USER" &>/dev/null; then
  echo "üë§ –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $PROXY_USER..."
  useradd -M -s /usr/sbin/nologin "$PROXY_USER"
fi

# 5) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
echo "${PROXY_USER}:${PROXY_PASS}" | chpasswd

# 6) –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî dev –ø–æ –º–∞—Ä—à—Ä—É—Ç—É –∫ 8.8.8.8)
EXT_IFACE=$(ip route get 8.8.8.8 2>/dev/null | awk '/dev/ {for(i=1;i<=NF;i++){if($i=="dev"){print $(i+1); exit}}}')
if [[ -z "$EXT_IFACE" ]]; then
  echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º eth0"
  EXT_IFACE="eth0"
else
  echo "üåê –í–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω: $EXT_IFACE"
fi

# 7) –ü–∏—à–µ–º –∫–æ–Ω—Ñ–∏–≥ /etc/danted.conf
echo "üìÑ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º /etc/danted.conf..."
cat > /etc/danted.conf <<EOF
# Dante SOCKS5 Proxy with PAM authentication
logoutput: syslog

# –Ω–∞ –∫–∞–∫–æ–º –∞–¥—Ä–µ—Å–µ/–ø–æ—Ä—Ç—É —Å–ª—É—à–∞–µ–º SOCKS-–∫–ª–∏–µ–Ω—Ç–æ–≤
internal: 0.0.0.0 port = 1080

# –∫–∞–∫–æ–π –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
external: $EXT_IFACE

# –º–µ—Ç–æ–¥—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
socksmethod: username
clientmethod: pam

# –ø–æ–¥ –∫–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
user.privileged: root
user.notprivileged: nobody

# —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect error
}

# —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å TCP –∏ UDP –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    protocol: tcp udp
    log: connect error
}
EOF

# 8) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∞–µ—Ä–≤–æ–ª (ufw –∏–ª–∏ iptables)
echo "üîí –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç 1080 –≤ —Ñ–∞–µ—Ä–≤–æ–ª–µ..."
if command -v ufw &>/dev/null; then
  ufw allow 1080/tcp
else
  # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
  if ! iptables -C INPUT -p tcp --dport 1080 -j ACCEPT &>/dev/null; then
    iptables -A INPUT -p tcp --dport 1080 -j ACCEPT
  fi
fi

# 9) –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∏ –≤–∫–ª—é—á–∞–µ–º —Å–µ—Ä–≤–∏—Å
echo "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º danted –∏ –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫..."
systemctl daemon-reload
systemctl restart danted
systemctl enable danted

# 10) –ò—Ç–æ–≥
cat <<EOS

‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

–¢–µ–ø–µ—Ä—å –≤–∞—à —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç SOCKS5-–ø—Ä–æ–∫—Å–∏ –Ω–∞ –ø–æ—Ä—Ç—É 1080 —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ PAM.

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞ (–ø—Ä–∏–º–µ—Ä curl):

  curl --socks5-hostname \
       ${PROXY_USER}:${PROXY_PASS}@your.server.com:1080 \
       https://ifconfig.me

–í –±—Ä–∞—É–∑–µ—Ä–µ (SwitchyOmega –∏ —Ç.–ø.) —É–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å:

  ‚Ä¢ Protocol: SOCKS5  
  ‚Ä¢ Host:     your.server.com  
  ‚Ä¢ Port:     1080  
  ‚Ä¢ Username: $PROXY_USER  
  ‚Ä¢ Password: (—Ç–æ—Ç, —á—Ç–æ –≤—ã –≤–≤–µ–ª–∏)

EOS
